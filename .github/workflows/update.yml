name: Update Master Playlist

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # --------------------------------------------------
      # STEP 1: CHECKOUT
      # --------------------------------------------------
      - name: Checkout repo
        uses: actions/checkout@v4

      # --------------------------------------------------
      # STEP 2: CREATE REQUIRED FOLDERS
      # --------------------------------------------------
      - name: Prepare folders
        run: |
          mkdir -p build
          mkdir -p sources

      # --------------------------------------------------
      # STEP 3: DOWNLOAD SOURCES (SECRETS)
      # --------------------------------------------------
      - name: Download playlists
        env:
          SRC_LGTV:    ${{ secrets.SRC_LGTV }}
          SRC_JTV:     ${{ secrets.SRC_JTV }}
          SRC_TATA_TV: ${{ secrets.SRC_TATA_TV }}
        run: |
          wget -q -O sources/lgtv.m3u     "$SRC_LGTV"     || true
          wget -q -O sources/jtv.m3u      "$SRC_JTV"      || true
          wget -q -O sources/tata_tv.m3u  "$SRC_TATA_TV"  || true

      # --------------------------------------------------
      # STEP 4: BUILD MASTER PLAYLIST
      # --------------------------------------------------
      - name: Build playlist
        run: |
          mkdir -p build

          TEMP_FILE="build/liveent.tmp"
          FILTERED_FILE="build/liveent.filtered"
          FINAL_FILE="build/liveent.xyn"

          echo "#EXTM3U" > "$TEMP_FILE"

          # ---------------- STATIC ----------------
          if [ -f Static/my_static ]; then
            sed '1d' Static/my_static >> "$TEMP_FILE"
          fi

          # ---------------- TATA TV (KIDS ONLY) ----------------
          if [ -f sources/tata_tv.m3u ]; then
            sed '1d' sources/tata_tv.m3u | awk '
              /^#EXTINF/ {
                keep = ($0 ~ /group-title="KIDS - 24X7"/)
                if (keep) {
                  gsub(/group-title="KIDS - 24X7"/, "group-title=\"Kids 24/7\"")
                }
              }
              keep { print }
            ' >> "$TEMP_FILE"
          fi

          # ---------------- LGTV ----------------
          [ -f sources/lgtv.m3u ] && sed '1d' sources/lgtv.m3u >> "$TEMP_FILE"

          # ---------------- JIOTV ----------------
          [ -f sources/jtv.m3u ] && sed '1d' sources/jtv.m3u >> "$TEMP_FILE"

          # --------------------------------------------------
          # GLOBAL CHANNEL NAME FILTER (CASE-INSENSITIVE)
          # Edit keywords freely later
          # --------------------------------------------------
          awk '
            BEGIN {
              IGNORECASE = 1
            }

            /^#EXTINF/ {
              name = $0
              sub(/.*?,/, "", name)

              if (name ~ /(tamil|telugu|kannada|bangla|malayalam|english|test|wow|swayam|sathee|bie|cie|vidya|gujarat|bengali|asianet|maa|ptc|vijay|etv|aath|rongeen|raj|punjab|manorama|mahaa|jaya|gemini|udaya|salaam|biskope|surya|adithya|amrita|colors super$|arunprabha|girnar|kashir|oriya|saptagiri|urdu|podhigai|desi channel$|kairali|jalsha|studio|apex|flower|jonack|kalaignar|makkal|mango|may|mk|moon|nakshatra|bangalore|peppers|polimer|puthu|sanjha|sidharth|spondon|kiran|sun tv|sundrani|suvarna|thanthi|vaanavil|vasanth|vendhar|vissa|jomjomat|j movies|ktv|maha|mahua|pitaara|public m|sun life|tabbar|thalaa|tolly|chintu|chutti|kochu|kushi|naap|east|sun music|sun news|nick junior|sonic marathi$|rang$|sristi|teh|haryana|mh)/) {
                skip = 1
              } else {
                skip = 0
                print
              }
              next
            }

            !skip {
              print
            }
          ' "$TEMP_FILE" > "$FILTERED_FILE"

          # --------------------------------------------------
          # DEDUPLICATION (BY CHANNEL NAME â€” FIRST WINS)
          # --------------------------------------------------
          awk '
            /^#EXTINF/ {
              name = $0
              sub(/.*?,/, "", name)

              if (!(name in seen)) {
                seen[name] = 1
                keep = 1
                print
              } else {
                keep = 0
              }
              next
            }

            keep { print }
          ' "$FILTERED_FILE" > "$FINAL_FILE"

          # ---------------- CLEANUP ----------------
          sed -i '/githubusercontent.com/d' "$FINAL_FILE"
          sed -i '/raw.githubusercontent.com/d' "$FINAL_FILE"

          # ---------------- VERIFY ----------------
          echo "---- BUILD OUTPUT ----"
          ls -lh build
          wc -l "$FINAL_FILE"

      # --------------------------------------------------
      # STEP 5: COMMIT & PUSH
      # --------------------------------------------------
      - name: Commit & push
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add build/liveent.xyn
          git diff --cached --quiet || git commit -m "Auto update liveent playlist"
          git push
