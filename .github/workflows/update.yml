name: Update Master Playlist

# --------------------------------------------------
# TRIGGERS
# --------------------------------------------------
on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # --------------------------------------------------
      # STEP 1: CHECKOUT REPOSITORY
      # --------------------------------------------------
      - name: Checkout repo
        uses: actions/checkout@v4

      # --------------------------------------------------
      # STEP 2: ENSURE build/ EXISTS (GIT-TRACKED)
      # --------------------------------------------------
      - name: Ensure build folder exists
        run: |
          mkdir -p build
          touch build/.gitkeep
          git add build/.gitkeep
          git commit -m "Ensure build folder exists" || echo "No changes"
          git push || echo "Push skipped"

      # --------------------------------------------------
      # STEP 3: CREATE SOURCES FOLDER
      # --------------------------------------------------
      - name: Create sources folder
        run: mkdir -p sources

      # --------------------------------------------------
      # STEP 4: DOWNLOAD SOURCE PLAYLISTS (SECRETS)
      # --------------------------------------------------
      - name: Download playlists
        env:
          SRC_LGTV:    ${{ secrets.SRC_LGTV }}
          SRC_JTV:     ${{ secrets.SRC_JTV }}
          SRC_ZEE5:    ${{ secrets.SRC_ZEE5 }}
          SRC_TATA_TV: ${{ secrets.SRC_TATA_TV }}
          SRC_SONY:    ${{ secrets.SRC_SONY }}
        run: |
          wget -q -O sources/lgtv.m3u     "$SRC_LGTV"
          wget -q -O sources/jtv.m3u      "$SRC_JTV"
          wget -q -O sources/zee5.m3u     "$SRC_ZEE5"
          wget -q -O sources/tata_tv.m3u  "$SRC_TATA_TV"
          wget -q -O sources/sony.m3u     "$SRC_SONY"

      # --------------------------------------------------
      # STEP 5: BUILD MASTER PLAYLIST
      # --------------------------------------------------
      - name: Build master playlist
        run: |
          mkdir -p build

          # --------------------------------------------------
          # CREATE TEMP WORKING FILE
          # --------------------------------------------------
          echo "#EXTM3U" > build/liveent.tmp

          # ==================================================
          # STATIC PLAYLIST (HIGHEST PRIORITY)
          # ==================================================
          if [ -f static/my_static.m3u ]; then
            sed '1d' static/my_static.m3u >> build/liveent.tmp
          fi

          # ==================================================
          # ZEE5 (RAW)
          # ==================================================
          if [ -f sources/zee5.m3u ]; then
            sed '1d' sources/zee5.m3u >> build/liveent.tmp
          fi

          # ==================================================
          # SONY (RAW)
          # ==================================================
          if [ -f sources/sony.m3u ]; then
            sed '1d' sources/sony.m3u >> build/liveent.tmp
          fi

          # ==================================================
          # TATA TV (FILTER: ONLY KIDS CHANNELS)
          # ==================================================
          if [ -f sources/tata_tv.m3u ]; then
            sed '1d' sources/tata_tv.m3u \
            | awk '
                /^#EXTINF/ {
                  keep = ($0 ~ /group-title="KIDS - 24X7"/)
                  if (keep) {
                    gsub(/group-title="KIDS - 24X7"/, "group-title=\"Kids 24/7\"")
                  }
                }
                keep { print }
              ' >> build/liveent.tmp
          fi

          # ==================================================
          # LGTV (RAW)
          # ==================================================
          if [ -f sources/lgtv.m3u ]; then
            sed '1d' sources/lgtv.m3u >> build/liveent.tmp
          fi

          # ==================================================
          # JIOTV (RAW)
          # ==================================================
          if [ -f sources/jtv.m3u ]; then
            sed '1d' sources/jtv.m3u >> build/liveent.tmp
          fi

          # --------------------------------------------------
          # DEDUPLICATION (BY CHANNEL NAME â€“ FIRST WINS)
          # --------------------------------------------------
          awk '
            /^#EXTINF/ {
              name = $0
              sub(/.*?,/, "", name)

              if (!(name in seen)) {
                seen[name] = 1
                keep = 1
                print
              } else {
                keep = 0
              }
              next
            }
            keep { print }
          ' build/liveent.tmp > build/liveent.xyn

          # --------------------------------------------------
          # SAFETY CLEANUP
          # --------------------------------------------------
          sed -i '/githubusercontent.com/d' build/liveent.xyn
          sed -i '/raw.githubusercontent.com/d' build/liveent.xyn

      # --------------------------------------------------
      # STEP 6: COMMIT & PUSH FINAL PLAYLIST
      # --------------------------------------------------
      - name: Commit and push playlist
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add build/liveent.xyn
          git diff-index --quiet HEAD || git commit -m "Auto update liveent playlist"
          git push || echo "No changes to push"
